<?xml version='1.0' encoding='windows-1252'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>
    <Product
        Id='*'
        Name='Harbor'
        UpgradeCode='7166EBE5-A7FB-4F7B-8285-BA9ACAE23E6A'
        Manufacturer='Eduard Olteanu'
        Language='1033'
        Codepage='1252'
        Version='$(var.Version)'>

        <Package Id='*'
            Keywords='Installer'
            Manufacturer='Eduard Olteanu'
            InstallerVersion='450'
            Languages='1033'
            Compressed='yes'
            InstallScope='perUser'
            SummaryCodepage='1252'
            />

        <MajorUpgrade
            Schedule='afterInstallInitialize'
            DowngradeErrorMessage='A newer version of [ProductName] is already installed. Setup will now exit.'/>

        <Media Id='1' Cabinet='media1.cab' EmbedCab='yes' DiskPrompt='CD-ROM #1'/>
        <Property Id='DiskPrompt' Value='Harbor Installation'/>

        <Directory Id='TARGETDIR' Name='SourceDir'>
            <Directory Id='LocalAppDataFolder'>
                <Directory Id='APPLICATIONFOLDER' Name='Harbor'>
                    <!-- Icon Files -->
                    <Component Id='IconsComponent' Guid='F6A7B8C9-D0E1-4F5A-3B4C-5D6E7F8A9B0C'>
                        <File
                            Id='IconHFile'
                            Name='icon_h.ico'
                            DiskId='1'
                            Source='$(var.CargoTargetBinDir)\..\..\assets\icon_h.ico'
                            />
                        <File
                            Id='HarborIconFile'
                            Name='harbor.ico'
                            DiskId='1'
                            Source='$(var.CargoTargetBinDir)\..\..\assets\harbor.ico'
                            />
                        <RegistryValue
                            Root='HKCU'
                            Key='Software\Harbor'
                            Name='IconsInstalled'
                            Type='integer'
                            Value='1'
                            KeyPath='yes'
                            />
                    </Component>
                    
                    <!-- Default YAML Configuration -->
                    <Component Id='DefaultConfigComponent' Guid='A9B8C7D6-E5F4-4A3B-2C1D-0E9F8A7B6C5D'>
                        <File
                            Id='DefaultConfigFile'
                            Name='harbor.downloads.yaml.default'
                            DiskId='1'
                            Source='$(var.CargoTargetBinDir)\..\..\harbor.downloads.yaml'
                            />
                        <RegistryValue
                            Root='HKCU'
                            Key='Software\Harbor'
                            Name='DefaultConfigInstalled'
                            Type='integer'
                            Value='1'
                            KeyPath='yes'
                            />
                    </Component>
                    
                    <!-- Harbor Tray Executable -->
                    <Component Id='HarborTrayExeComponent' Guid='A1B2C3D4-E5F6-4A5B-8C9D-0E1F2A3B4C5D'>
                        <File
                            Id='HarborTrayExe'
                            Name='harbor-tray.exe'
                            DiskId='1'
                            Source='$(var.CargoTargetBinDir)\harbor-tray.exe'
                            />
                        <RegistryValue
                            Root='HKCU'
                            Key='Software\Harbor'
                            Name='TrayExeInstalled'
                            Type='integer'
                            Value='1'
                            KeyPath='yes'
                            />
                    </Component>
                    
                    <!-- Harbor Tray Registry (Auto-start) -->
                    <Component Id='HarborTrayAutoStartComponent' Guid='B2C3D4E5-F6A7-4B5C-9D0E-1F2A3B4C5D6E'>
                        <RegistryValue
                            Root='HKCU'
                            Key='Software\Microsoft\Windows\CurrentVersion\Run'
                            Name='HarborTray'
                            Type='string'
                            Value='[APPLICATIONFOLDER]harbor-tray.exe'
                            KeyPath='yes'
                            />
                    </Component>
                    
                    <!-- Harbor CLI Executable -->
                    <Component Id='HarborCliExeComponent' Guid='C3D4E5F6-A7B8-4C5D-0E1F-2A3B4C5D6E7F'>
                        <File
                            Id='HarborCliExe'
                            Name='harbor-cli.exe'
                            DiskId='1'
                            Source='$(var.CargoTargetBinDir)\harbor-cli.exe'
                            />
                        <RegistryValue
                            Root='HKCU'
                            Key='Software\Harbor'
                            Name='CliExeInstalled'
                            Type='integer'
                            Value='1'
                            KeyPath='yes'
                            />
                    </Component>
                    
                    <!-- PATH Environment Variable -->
                    <Component Id='PathComponent' Guid='C86160C1-433A-44CD-B6B5-82EC73C449AD'>
                        <RegistryValue
                            Root='HKCU'
                            Key='Software\Harbor'
                            Name='PathInstalled'
                            Type='integer'
                            Value='1'
                            KeyPath='yes'
                            />
                        <Environment
                            Id='PATH'
                            Name='PATH'
                            Value='[APPLICATIONFOLDER]'
                            Permanent='no'
                            Part='last'
                            Action='set'
                            System='no'/>
                    </Component>
                    
                    <!-- Cleanup component for the directory -->
                    <Component Id='CleanupMainApplicationFolder' Guid='D4E5F6A7-B8C9-4D5E-1F2A-3B4C5D6E7F8A'>
                        <RegistryValue
                            Root='HKCU'
                            Key='Software\Harbor'
                            Name='Installed'
                            Type='integer'
                            Value='1'
                            KeyPath='yes'
                            />
                        <RemoveFolder Id='APPLICATIONFOLDER' On='uninstall'/>
                    </Component>
                </Directory>
            </Directory>
            
            <!-- Start Menu Shortcut -->
            <Directory Id="ProgramMenuFolder">
                <Directory Id="ApplicationProgramsFolder" Name="Harbor">
                    <Component Id="ApplicationShortcut" Guid='E5F6A7B8-C9D0-4E5F-2A3B-4C5D6E7F8A9B'>
                        <Shortcut Id="ApplicationStartMenuShortcut"
                                  Name="Harbor"
                                  Description="Harbor Downloads Organizer"
                                  Target="[APPLICATIONFOLDER]harbor-tray.exe"
                                  WorkingDirectory="APPLICATIONFOLDER"
                                  Icon="HarborIcon"/>
                        <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall"/>
                        <RegistryValue Root="HKCU" Key="Software\Harbor" Name="ShortcutInstalled" Type="integer" Value="1" KeyPath="yes"/>
                    </Component>
                </Directory>
            </Directory>
        </Directory>

        <Feature
            Id='Binaries'
            Title='Application'
            Description='Installs all binaries.'
            Level='1'
            ConfigurableDirectory='APPLICATIONFOLDER'
            AllowAdvertise='no'
            Display='expand'
            Absent='disallow'>
            
            <ComponentRef Id='IconsComponent'/>
            <ComponentRef Id='DefaultConfigComponent'/>
            <ComponentRef Id='HarborTrayExeComponent'/>
            <ComponentRef Id='HarborTrayAutoStartComponent'/>
            <ComponentRef Id='HarborCliExeComponent'/>
            <ComponentRef Id='PathComponent'/>
            <ComponentRef Id='ApplicationShortcut'/>
            <ComponentRef Id='CleanupMainApplicationFolder'/>
        </Feature>

        <SetProperty Id='ARPINSTALLLOCATION' Value='[APPLICATIONFOLDER]' After='CostFinalize'/>
        
        <!-- UI Configuration -->
        <UI>
            <UIRef Id='WixUI_InstallDir'/>
            <Publish Dialog='WelcomeDlg' Control='Next' Event='NewDialog' Value='InstallDirDlg' Order='2'>1</Publish>
            <Publish Dialog='InstallDirDlg' Control='Back' Event='NewDialog' Value='WelcomeDlg' Order='2'>1</Publish>
        </UI>
        <Property Id='WIXUI_INSTALLDIR' Value='APPLICATIONFOLDER' />

        <!-- Icon definitions -->
        <Icon Id="HarborIcon" SourceFile="$(var.CargoTargetBinDir)\..\..\assets\harbor.ico" />

        <!-- Custom Action to launch the app after installation -->
        <!-- Use SetProperty to properly set the target for WixShellExec -->
        <SetProperty Id="WixShellExecTarget" Value="[APPLICATIONFOLDER]harbor-tray.exe" Before="LaunchApplication" Sequence="execute">
            NOT Installed AND NOT REMOVE
        </SetProperty>
        
        <CustomAction Id="LaunchApplication"
            BinaryKey="WixCA"
            DllEntry="WixShellExec"
            Impersonate="yes" />

        <InstallExecuteSequence>
            <Custom Action="LaunchApplication" After="InstallFinalize">
                NOT Installed AND NOT REMOVE
            </Custom>
        </InstallExecuteSequence>

    </Product>
</Wix>
